<html>

<head>
  <base href="https://cdn.jsdelivr.net/gh/genizy/polytrack@main/">
  <script>
    // Wait for DOM loaded first (to safely query base)
    document.addEventListener('DOMContentLoaded', async () => {
      window.jkdfgnjkndfg = document.querySelector('base').href;

      // Fetch worker script and create blob URL
      const res = await fetch("simulation_worker.bundle.js");
      const text = await res.text();
      const replacedText = text.replaceAll("replacethisplease", window.jkdfgnjkndfg);
      const blob = new Blob([replacedText], { type: 'application/javascript' });
      window.simulationworker = URL.createObjectURL(blob);

      // Override Worker now that simulationworker blob URL is ready
      const ogworker = window.Worker;
      window.Worker = function (scripturl, options) {
        if (typeof scripturl === 'string' && scripturl.toLowerCase() === "simulation_worker.bundle.js") {
          scripturl = window.simulationworker;
        }
        return new ogworker(scripturl, options);
      };
      window.Worker.prototype = ogworker.prototype;

      // Patch fetch and XHR as you had before
      const ogfetch = window.fetch;
      window.fetch = async function (input, init) {
        if (typeof input === "string") {
          input = input.replace("vps.kodub.com:43273", "vpskodub.tmena1565.workers.dev");
        } else if (input instanceof Request) {
          const newUrl = input.url.replace("vps.kodub.com:43273", "vpskodub.tmena1565.workers.dev");
          input = new Request(newUrl, input);
        }
        return ogfetch(input, init);
      };

      const ogxml = XMLHttpRequest.prototype.open;
      XMLHttpRequest.prototype.open = function (method, url, ...rest) {
        if (typeof url === "string") {
          url = url.replace("vps.kodub.com:43273", "vpskodub.tmena1565.workers.dev");
        }
        return ogxml.call(this, method, url, ...rest);
      };

      // Fix webpack publicPath (critical)
      window.__webpack_public_path__ = window.jkdfgnjkndfg;

      // Dynamically load main.bundle.js now
      const script = document.createElement('script');
      script.type = 'module';
      script.src = 'main.bundle.js';
      document.body.appendChild(script);
    });
  </script>
  <link rel="manifest" href="manifest.json" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
</head>

<body>
  <canvas id="screen"></canvas>
  <div id="ui"></div>
  <div id="transition-layer"></div>
</body>

</html>
